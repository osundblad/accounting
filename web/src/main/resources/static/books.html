<!doctype html>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="bootstrap-dist/js/bootstrap.min.js"></script>
<script src="mithril/mithril.min.js"></script>
<script>
    var Book = function(data) {
        data = data || {id: null, name:"", description:""};
        this.id = m.prop(data.id);
        this.name = m.prop(data.name);
        this.description = m.prop(data.description);
    };
    Book.list = function(data) {
        return m.request({method: "GET", url: "/book", data: data})
    };
    Book.save = function(data) {
        return m.request({method: "POST", url: "/book", data: data})
    };

    var BooksWidget = {
        controller: function update() {
            this.books = Book.list();
            this.save = function(book) {
                Book.save(book).then(update.bind(this))
            }.bind(this)
        },
        view: function(ctrl) {
            return m("html", [
                m("head", [
                    m("link[href='bootstrap-dist/css/bootstrap.min.css'][rel=stylesheet]")
                ]),
                m("body", [
                    m("h2", "Some Books"),
                    m.component(BookForm, {onsave: ctrl.save}),
                    m.component(BookList, {books: ctrl.books})
                ])
            ])
        }
    };

    var BookForm = {
        controller: function(args) {
            this.book = m.prop(args.book || new Book())
        },
        view: function(ctrl, args) {
            var book = ctrl.book();

            return m("form", [
                m("label", "Name"),
                m("input", {oninput: m.withAttr("value", book.name), value: book.name()}),

                m("label", "Description"),
                m("input", {oninput: m.withAttr("value", book.description), value: book.description()}),

                m("button[type=button]", {onclick: args.onsave.bind(this, book)}, "Save")
            ])
        }
    };

    var BookList = {
        view: function(ctrl, args) {
            return m("table", [
                args.books().map(function(book) {
                    return m("tr", [
                        m("td", book.name),
                        m("td", book.description)
                    ])
                })
            ])
        }
    };

    m.mount(document, BooksWidget)
</script>
